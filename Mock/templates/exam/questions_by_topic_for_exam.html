{% extends 'base.html' %}
{% load static %}

{% block title %}Savollarni tanlash{% endblock %}

{% block extra_body %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const sectionIndex = new URLSearchParams(window.location.search).get('section_index');

        document.querySelectorAll('.select-question-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const questionId = this.dataset.questionId;
                const isSelected = this.dataset.isSelected === 'true';
                const action = isSelected ? 'remove_question_from_section' : 'add_question_to_section';

                fetch('', { // ✅ Fixed: Using a relative URL to point to the current page
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        action: action,
                        section_index: sectionIndex,
                        question_id: questionId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // ✅ Fixed: Toggling button state and text
                        if (action === 'add_question_to_section') {
                            this.textContent = 'Tanlangan';
                            this.dataset.isSelected = 'true';
                            this.classList.remove('bg-blue-500', 'hover:bg-blue-700');
                            this.classList.add('bg-green-500', 'hover:bg-green-700');
                        } else {
                            this.textContent = 'Tanlash';
                            this.dataset.isSelected = 'false';
                            this.classList.remove('bg-green-500', 'hover:bg-green-700');
                            this.classList.add('bg-blue-500', 'hover:bg-blue-700');
                        }
                    } else {
                        alert(data.message);
                    }
                });
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-4 md:p-8">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Savollarni tanlash: "{{ topic_name }}"</h2>

        {% for message in messages %}
            <div class="p-4 mb-4 text-sm rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'error' %}bg-red-100 text-red-700{% endif %}" role="alert">
                {{ message }}
            </div>
        {% endfor %}

        <div class="space-y-4">
            {% for question in questions %}
            <div class="flex justify-between items-center p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm">
                <div>
                    <p class="text-gray-700">{{ question.translations.first.text|safe|truncatewords:20 }}</p>
                    <p class="text-sm text-gray-500">
                        {% if question.subtopic %}{{ question.subtopic.name }}{% else %}Mavzulanmagan{% endif %}
                    </p>
                </div>
                <button
                    class="select-question-btn py-2 px-4 rounded-md font-bold text-white transition-colors duration-200
                    {% if question.id|stringformat:"s" in selected_questions %}bg-green-500 hover:bg-green-700{% else %}bg-blue-500 hover:bg-blue-700{% endif %}"
                    data-question-id="{{ question.id }}"
                    data-is-selected="{% if question.id|stringformat:"s" in selected_questions %}true{% else %}false{% endif %}">
                    {% if question.id|stringformat:"s" in selected_questions %}Tanlangan{% else %}Tanlash{% endif %}
                </button>
            </div>
            {% empty %}
            <p class="text-gray-500 text-center">Bu mavzuda savollar mavjud emas.</p>
            {% endfor %}
        </div>

        <div class="mt-6">
            <a href="{% url 'create_static_exam_step2' %}" class="text-blue-500 hover:underline">Orqaga qaytish</a>
        </div>
    </div>
</div>
{% endblock %}