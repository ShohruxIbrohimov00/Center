{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 md:p-8">
    <div class="card-section">
        <h1 class="card-title">Savollar</h1>
        
        <div class="space-y-6">
            {% for question in questions %}
                <div class="card-section p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-semibold text-gray-700">Savol {{ forloop.counter }}:</h4>
                        <button class="add-question-btn btn btn-primary flex-shrink-0" data-question-id="{{ question.id }}">
                            Tanlash
                        </button>
                    </div>

                    <div class="prose max-w-none mb-4">
                        {% if question.text %}
                            <p>{{ question.text|safe }}</p>
                        {% else %}
                            <p class="text-gray-400 italic">Savol matni mavjud emas.</p>
                        {% endif %}
                    </div>
                    
                    {% if question.image %}
                        <div class="mb-4">
                            <img src="{{ question.image.url }}" alt="Savolga oid rasm" class="w-full h-auto rounded-lg">
                        </div>
                    {% endif %}

                    {% if question.passage %}
                        <div class="mb-4 p-4 bg-gray-100 rounded-lg border-l-4 border-gray-400">
                            <h4 class="font-semibold text-gray-700 mb-2">Matn: {{ question.passage.title }}</h4>
                            <div class="prose max-w-none">
                                {{ question.passage.content|safe }}
                            </div>
                        </div>
                    {% endif %}

                    <div class="mt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">Javob variantlari:</h4>
                        {% if question.answer_format == 'short_answer' %}
                            <div class="p-3 rounded-lg bg-green-100 text-green-800 font-semibold">
                                To'g'ri javob: {{ question.correct_short_answer }}
                            </div>
                        {% elif question.options.all %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {% for option in question.options.all %}
                                    <div class="flex items-start space-x-2 p-3 rounded-lg {% if option.is_correct %}bg-green-100 text-green-800 font-semibold{% else %}bg-gray-100 text-gray-700{% endif %}">
                                        <span class="{% if option.is_correct %}text-green-600{% else %}text-gray-400{% endif %} flex-shrink-0 mt-1">
                                            <i class="fas {% if option.is_correct %}fa-check-circle{% else %}fa-circle{% endif %}"></i>
                                        </span>
                                        <div class="prose max-w-none">
                                            {% if option.text %}
                                                {{ option.text|safe }}
                                            {% else %}
                                                <span class="text-gray-400 italic">Javob matni mavjud emas.</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="p-3 text-gray-400 italic">
                                Javob variantlari mavjud emas.
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p class="text-gray-600">Savollar topilmadi.</p>
            {% endfor %}
        </div>
        
        <div class="mt-8 flex justify-end">
            <a href="{% url 'create_static_exam_step2' exam_id=exam_id %}" class="btn btn-secondary">
                Orqaga qaytish
            </a>
        </div>
    </div>
</div>

<form id="csrf-form" style="display:none;">
    {% csrf_token %}
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const csrftoken = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]').value;
        const sectionIndex = "{{ request.GET.section_index }}";
        const examId = "{{ exam_id }}";

        document.querySelectorAll('.add-question-btn').forEach(button => {
            button.addEventListener('click', function() {
                const questionId = this.dataset.questionId;
                
                fetch(`/create-static/step-2/${examId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        action: 'add_question',
                        section_index: sectionIndex,
                        question_id: questionId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        this.textContent = 'Tanlandi';
                        this.disabled = true;
                        this.classList.remove('btn-primary');
                        this.classList.add('bg-green-500', 'text-white');
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Savolni qo\'shishda xato yuz berdi:', error));
            });
        });
    });
</script>
{% endblock %}