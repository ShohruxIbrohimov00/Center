{% extends 'base.html' %}
{% load static %}

{% block title %}Bo'limni tahrirlash{% endblock %}

{% block extra_body %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const sectionContainer = document.getElementById('section-container');
    const addQuestionsLink = document.getElementById('add-questions-link');
    const sectionIndex = sectionContainer.dataset.index;
    const questionsList = document.getElementById('selected-questions-list');
    const questionCountSpan = document.getElementById('selected-questions-count');
    const sectionUrl = "{% url 'edit_section' section_id=section.id %}";

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'p-4 mb-4 text-sm rounded-lg bg-red-100 text-red-700';
        errorDiv.textContent = message;
        sectionContainer.prepend(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    }

    function renderQuestionsList(questionsData) {
        questionsList.innerHTML = '';
        const sortedQuestions = Object.entries(questionsData)
            .sort(([, a], [, b]) => a - b);

        sortedQuestions.forEach(([id]) => {
            const li = document.createElement('div');
            li.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow-sm border border-gray-200';
            li.innerHTML = `
                <span class="text-sm text-gray-700">Savol ID: ${id}</span>
                <button type="button" data-question-id="${id}" class="remove-question-btn text-red-500 hover:text-red-700 text-sm font-semibold">
                    O'chirish
                </button>
            `;
            questionsList.appendChild(li);
        });

        questionCountSpan.textContent = sortedQuestions.length;
    }

    async function saveSection() {
        try {
            const sectionData = {
                section_type: sectionContainer.querySelector('[name="section_type"]').value,
                duration_minutes: parseInt(sectionContainer.querySelector('[name="duration_minutes"]').value) || 0,
                max_questions: parseInt(sectionContainer.querySelector('[name="max_questions"]').value) || 0,
                module_number: parseInt(sectionContainer.querySelector('[name="module_number"]').value) || 0,
                static_questions: JSON.parse(sectionContainer.dataset.questions || '{}')
            };

            const response = await fetch(sectionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    action: 'save_section_data',
                    section_data: sectionData
                })
            });

            const data = await response.json();
            if (data.status !== 'success') {
                throw new Error(data.message || "Bo'limni saqlashda xato yuz berdi");
            }
            return data;
        } catch (error) {
            console.error('Bo\'limni saqlashda xato:', error);
            showError('Bo\'limni saqlashda xato: ' + error.message);
            return { status: 'error', message: error.message };
        }
    }

    async function removeQuestion(questionId) {
        try {
            const response = await fetch(sectionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    action: 'remove_question',
                    question_id: questionId
                })
            });

            const data = await response.json();
            if (data.status === 'success') {
                const questionsData = JSON.parse(sectionContainer.dataset.questions || '{}');
                delete questionsData[questionId];

                const updatedQuestionsData = {};
                Object.keys(questionsData)
                    .sort((a, b) => questionsData[a] - questionsData[b])
                    .forEach((qid, index) => {
                        updatedQuestionsData[qid] = index + 1;
                    });

                sectionContainer.dataset.questions = JSON.stringify(updatedQuestionsData);
                renderQuestionsList(updatedQuestionsData);
                await saveSection();
            } else {
                throw new Error(data.message || "Savolni o'chirishda xato");
            }
        } catch (error) {
            console.error('Savolni o\'chirishda xato:', error);
            showError('Savolni o\'chirishda xato: ' + error.message);
        }
    }

    sectionContainer.addEventListener('click', async (event) => {
        const removeQuestionBtn = event.target.closest('.remove-question-btn');
        if (removeQuestionBtn) {
            await removeQuestion(removeQuestionBtn.dataset.questionId);
        }
    });

    if (addQuestionsLink) {
        addQuestionsLink.addEventListener('click', async (event) => {
            event.preventDefault();
            const result = await saveSection();
            if (result.status === 'success') {
                window.location.href = addQuestionsLink.href;
            } else {
                showError("Savollarni tanlashga o'tishdan oldin bo'limni saqlashda xato yuz berdi.");
            }
        });
    }

    sectionContainer.addEventListener('change', async (event) => {
        if (event.target.matches('input, select')) {
            await saveSection();
        }
    });

    try {
        const initialQuestionsData = JSON.parse(sectionContainer.dataset.questions || '{}');
        renderQuestionsList(initialQuestionsData);
    } catch (error) {
        console.error('Boshlang\'ich savollarni yuklashda xato:', error);
        showError('Boshlang\'ich savollarni yuklashda xato yuz berdi.');
    }
});
</script>

<style>
.hidden { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-lg mt-10">
    {% csrf_token %}
    <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Bo'limni tahrirlash</h1>
    <p class="text-center text-gray-500 mb-8">"{{ section.exam.title }}" imtihonidagi bo'limni tahrirlash.</p>

    {% for message in messages %}
        <div class="p-4 mb-4 text-sm rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'error' %}bg-red-100 text-red-700{% endif %}" role="alert">
            {{ message }}
        </div>
    {% endfor %}

    <div id="section-container"
         class="section-item p-4 border rounded-lg bg-gray-50 flex flex-col space-y-4"
         data-index="{{ section_index }}"
         data-questions='{{ section.static_questions_json|safe }}'>

        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 font-medium">Bo'lim turi:</label>
                <select name="section_type" class="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-blue-500" required>
                    {% for value, label in section_type_choices %}
                        <option value="{{ value }}" {% if section.section_type == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-gray-700 font-medium">Davomiyligi (daqiqada):</label>
                <input type="number" name="duration_minutes" value="{{ section.duration_minutes|default:'1' }}"
                       class="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-blue-500" min="1" required>
            </div>
            <div>
                <label class="block text-gray-700 font-medium">Maksimal savollar soni:</label>
                <input type="number" name="max_questions" value="{{ section.max_questions|default:'1' }}"
                       class="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-blue-500" min="1" required>
            </div>
            <div>
                <label class="block text-gray-700 font-medium">Modul raqami:</label>
                <input type="number" name="module_number" value="{{ section.module_number|default:'1' }}"
                       class="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-blue-500" min="1" required>
            </div>
        </div>

        <div class="mt-6">
            <h5 class="font-semibold text-gray-700">Tanlangan savollar: <span id="selected-questions-count">{{ section.static_questions|length }}</span></h5>
            <div id="selected-questions-list" class="space-y-2 mt-2"></div>
            <a href="{% url 'exam_topics_list' exam_id=section.exam.id %}?section_index={{ section_index }}"
               id="add-questions-link"
               class="text-blue-500 hover:underline mt-2 inline-block font-medium">
                Savollarni tanlash
            </a>
        </div>
    </div>

    <div class="flex justify-center mt-6 gap-4">
        <a href="{% url 'exam_detail' section.exam.id %}"
           class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-150">
            Orqaga qaytish
        </a>
        <button type="button" id="save-section-btn"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150">
            Saqlash
        </button>
    </div>
</div>
{% endblock %}