{% load static %}
{% with exam=exam_data.obj %}
<div class="exam-card w-72 md:w-80 flex-shrink-0" data-created-at="{{ exam.created_at|date:'Y-m-d' }}">
    <div class="relative bg-white rounded-xl shadow-lg border border-slate-100 flex flex-col h-full transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-1">
        
        {# Premium Badge #}
        {% if exam.is_premium %}
            <div class="absolute top-3 right-3 flex items-center justify-center w-8 h-8 bg-indigo-100 rounded-full z-10" title="Pullik imtihon">
                <i class="fa-solid fa-lock text-indigo-500 text-sm"></i>
            </div>
        {% endif %}

        <div class="p-5 flex-grow flex flex-col">
            
            {# Sarlavha va Tavsif #}
            <div class="flex-grow">
                <h3 class="text-lg font-bold text-slate-800 mb-3 line-clamp-2 pr-8">
                    <i class="fa-solid fa-file-lines text-success-600 mr-2"></i>
                    {{ exam.title }}
                </h3>
                <p class="text-slate-500 text-sm mb-4 line-clamp-2">
                    <i class="fa-solid fa-info-circle text-slate-500 mr-2"></i>
                    {{ exam.description|default:"Tavsif mavjud emas." }}
                </p>

                {# Asosiy ma'lumotlar ro'yxati #}
                <div class="space-y-2 mb-4">
                    <div class="info-item text-sm text-slate-600">
                        <i class="fa-regular fa-user text-slate-500 w-4"></i>
                        <span>Oâ€˜qituvchi: {{ exam.teacher.get_full_name|default:exam.teacher.username }}</span>
                    </div>
                    <div class="info-item text-sm text-slate-600">
                        <i class="fa-regular fa-calendar text-slate-500 w-4"></i>
                        <span>Yaratilgan: {{ exam.created_at|date:"F j, Y" }}</span>
                    </div>
                    {% if exam_data.unique_users_count > 0 %}
                    <div class="info-item text-sm text-slate-600">
                        <i class="fa-solid fa-users text-slate-500 w-4"></i>
                        <span>Ishlaganlar: {{ exam_data.unique_users_count }} oâ€˜quvchi</span>
                    </div>
                    {% endif %}
                    
                    {# ðŸ’¡ TUZATISH: Umumiy vaqt va Savollar soni (prepare_exam_data dan keladi) #}
                    <div class="info-item text-sm text-slate-600 font-semibold text-slate-800">
                        <i class="fa-regular fa-clock text-indigo-500 w-4"></i>
                        <span>Umumiy vaqt: {{ exam_data.total_duration|default:0 }} daqiqa</span>
                    </div>
                    <div class="info-item text-sm text-slate-600 font-semibold text-slate-800">
                        <i class="fa-solid fa-list-ol text-indigo-500 w-4"></i>
                        <span class="text-green-600">Savollar soni: {{ exam_data.total_questions|default:0 }} ta</span>
                    </div>
                </div>

                {# Boâ€˜limlar (Sections) - Savol sonini ko'rsatish #}
                <h4 class="text-xs font-semibold text-slate-500 mb-2 border-t pt-2 mt-4">BOâ€˜LIMLAR:</h4>
                <div class="flex flex-wrap gap-2 mb-4">
                    {% for section in exam_data.sections %}
                        {# section bu yerda dict: {'id': 1, ..., 'actual_question_count': 20, ...} #}
                        <span class="flex items-center gap-x-1.5 rounded-full bg-success-50 px-2.5 py-1 text-xs font-medium text-success-800" title="{{ section.actual_question_count }} savol, {{ section.duration_minutes }} daqiqa">
                            
                            {% if section.is_math %}
                                <i class="fa-solid fa-calculator text-success-600"></i>
                            {% else %}
                                <i class="fa-solid fa-book-open text-success-600"></i>
                            {% endif %}
                            
                            {# Bo'lim nomi va savol sonini ko'rsatish #}
                            {{ section.type_display }} (<b class="text-success-700">{{ section.actual_question_count }}</b>)
                        </span>
                    {% endfor %}
                </div>
            </div>
            
            {# Tugmalar qismi #}
            <div class="mt-auto pt-4 border-t border-slate-100">
                <div class="flex flex-col space-y-3">
                    {% if exam_data.can_start_exam %}
                        {# Testni Boshlash tugmasi #}
                        <button class="start-exam-btn btn btn-sm w-full btn-emerald" data-exam-id="{{ exam.id }}">
                            <i class="fa-solid fa-play mr-2"></i> Testni Boshlash
                        </button>
                        
                        {# ðŸ’¡ TUZATISH: Soâ€˜zlarni Yodlash (Flashcard) tugmasi - Agar FlashcardExam mavjud bo'lsa #}
                        {% if exam_data.has_flashcard_exam %}
                            {# flashcard_exam_view URL'iga borish. #}
                            <a href="{% url 'flashcard_exam_view' center.slug exam.id %}" class="btn btn-sm w-full btn-sky"> 
                                <i class="fa-solid fa-layer-group mr-2"></i> Soâ€˜zlarni Yodlash
                            </a>
                        {% endif %}
                        
                    {% else %}
                        {# Premium emasligi sababli sotib olish tugmasi #}
                        <a href="{% url 'price' center.slug %}" class="btn btn-sm w-full btn-rose">
                            <i class="fas fa-crown mr-2"></i> Paket sotib olish
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endwith %}