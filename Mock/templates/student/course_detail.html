{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.title }} - Kurs haqida batafsil ma'lumot{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 md:py-16 max-w-6xl">
    
    {# Asosiy Layout: 2/3 (Kontent) va 1/3 (Sidebar/O'ng panel) #}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
        
        {# ========================================================= #}
        {# CHAP USTUN: Kurs sarlavhasi, tavsifi va dasturi (2/3 qism) #}
        {# ========================================================= #}
        <div class="lg:col-span-2">
            
            {# Kurs sarlavhasi va tavsifi #}
            <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100 mb-10">
                <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4 leading-tight">{{ course.title }}</h1>
                <p class="text-xl text-slate-600 mb-6">{{ course.description|default:"Kursning keng qamrovli tavsifi bu yerda ko'rsatiladi." }}</p>
                
                {# Statistika (Chip ko'rinishida) #}
                <div class="flex flex-wrap items-center gap-x-6 gap-y-3 pt-4 border-t border-gray-100 mt-4">
                    
                    <span class="flex items-center text-sm font-semibold text-indigo-700 bg-indigo-50 px-3 py-1 rounded-full">
                        <i class="fas fa-users mr-2"></i> 
                        <b class="text-indigo-900">{{ students_count|default:"0" }}</b> o‚Äòquvchi
                    </span>
                    
                    <span class="flex items-center text-sm font-semibold text-green-700 bg-green-50 px-3 py-1 rounded-full">
                        <i class="fas fa-layer-group mr-2"></i> 
                        <b class="text-green-900">{{ total_lessons_count|default:"0" }}</b> dars
                    </span>
                    
                    {% if course.is_premium %}
                        <span class="flex items-center text-sm font-semibold text-amber-700 bg-amber-100 px-3 py-1 rounded-full">
                            <i class="fas fa-crown mr-2"></i> Premium kurs
                        </span>
                    {% endif %}
                </div>
            </div>
            
            {# Kursning To'liq Dasturi/RoadMap'i #}
            <div class="mb-10">
                <h2 class="text-3xl font-bold text-slate-800 mb-6 border-l-4 border-indigo-600 pl-3">Kurs dasturi</h2>
                
                {# Resurs statistikasi #}
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
                    
                    <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                        <i class="fas fa-film text-xl text-red-600 mb-1"></i>
                        <span class="block text-xs text-slate-700 font-medium">Videodarslar</span>
                        <span class="text-lg font-extrabold text-red-700">{{ total_videos_count|default:"0" }}</span>
                    </div>
                    
                    <div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                        <i class="fas fa-list-check text-xl text-orange-600 mb-1"></i>
                        <span class="block text-xs text-slate-700 font-medium">Vazifalar</span>
                        <span class="text-lg font-extrabold text-orange-700">{{ total_tasks_count|default:"0" }}</span>
                    </div>
                    
                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <i class="fas fa-download text-xl text-blue-600 mb-1"></i>
                        <span class="block text-xs text-slate-700 font-medium">Resurs fayllar</span>
                        <span class="text-lg font-extrabold text-blue-700">{{ total_files_count|default:"0" }}</span>
                    </div>
                    
                    <div class="p-3 bg-violet-50 rounded-lg border border-violet-200">
                        <i class="fas fa-vial text-xl text-violet-600 mb-1"></i>
                        <span class="block text-xs text-slate-700 font-medium">Testlar soni</span>
                        <span class="text-lg font-extrabold text-violet-700">{{ total_exams_count|default:"0" }}</span>
                    </div>
                </div>

                {# Kurs RoadMap'i (Accordion) #}
                <div class="space-y-4">
                    {% for module_data in roadmap_data %}
                    
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden" 
                         x-data="{ open: false, init() { if({{ module_data.module.order }} <= 1) { this.open = true } } }">
                        
                        {# MODUL SARLAVHASI #}
                        <div class="p-4 md:p-5 cursor-pointer select-none transition duration-150" 
                             :class="open ? 'bg-indigo-50 border-l-4 border-indigo-500' : 'hover:bg-gray-50'" 
                             @click="open = !open">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-4">
                                    <i class="fas fa-angle-down text-gray-500 transition-transform duration-300 flex-shrink-0 w-4 text-center" 
                                        :class="{ 'rotate-180 text-indigo-600': open }"></i>
                                    
                                    <h3 class="text-lg font-bold text-slate-800">
                                        <span class="text-indigo-600">{{ module_data.module.order }}. Modul:</span> {{ module_data.module.title }}
                                    </h3>
                                </div>
                                
                                <div class="flex-shrink-0 text-sm font-medium text-gray-500 hidden sm:block">
                                    <span class="whitespace-nowrap">{{ module_data.lessons|length }} darslik</span>
                                </div>
                            </div>
                        </div>
                        
                        {# DARS RO'YXATI #}
                        <div x-show="open" x-collapse.duration.400ms>
                            <ul class="divide-y divide-gray-100 bg-white border-t border-gray-200">
                                {% for lesson_data in module_data.lessons %}
                                
                                <li class="p-4 flex justify-between items-center text-sm transition duration-100 hover:bg-indigo-50/50">
                                    
                                    <div class="flex items-center flex-grow space-x-3">
                                        <div class="flex-shrink-0 w-5 text-center">
                                            {# Dars turi iconi #}
                                            {% if lesson_data.lesson.has_exam or lesson_data.lesson.related_exam %}
                                                <i class="fas fa-clipboard-check text-red-500"></i>
                                            {% else %}
                                                <i class="fas fa-circle-play text-indigo-500"></i>
                                            {% endif %}
                                        </div>

                                        {# NOMI #}
                                        <span class="text-base font-medium text-gray-700">
                                            {{ lesson_data.lesson.order }}. {{ lesson_data.lesson.title }}
                                        </span>
                                    </div>

                                    {# Resurs ikonkalari #}
                                    <div class="flex-shrink-0 ml-4 flex items-center space-x-3 text-sm text-gray-400">
                                        {% if lesson_data.has_video %}<i class="fas fa-video hover:text-indigo-600" title="Video resurs mavjud"></i>{% endif %}
                                        {% if lesson_data.has_task %}<i class="fas fa-list-check hover:text-orange-600" title="Amaliy vazifa mavjud"></i>{% endif %}
                                        {% if lesson_data.has_file %}<i class="fas fa-file-arrow-down hover:text-blue-600" title="Qo'shimcha fayllar mavjud"></i>{% endif %}
                                        {% if lesson_data.lesson.has_exam %}<i class="fas fa-edit hover:text-red-600" title="Test mavjud"></i>{% endif %}
                                    </div>
                                </li>
                                
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% empty %}
                    <div class="py-10 text-center text-gray-500 border-2 border-dashed rounded-xl bg-gray-50">
                        <i class="fas fa-exclamation-circle mb-2 text-3xl text-gray-400"></i>
                        <p class="text-lg font-medium">Hozircha kurs modullari va darslari qo'shilmagan.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
        </div>
        
        {# ========================================================= #}
        {# O'NG USTUN: CTA va O'qituvchi ma'lumoti - Yopishgan (STICKY) BLOK #}
        {# ========================================================= #}
        
        {# Sticky konteynerni lg ekranlar uchun belgilaymiz. top-24 (taxminan 96px) masofa qoldiramiz. #}
        <div class="lg:col-span-1 lg:sticky lg:top-12 h-fit space-y-8">
            
            {# üî• NARX VA CTA BLOKI üî• #}
            <div class="p-6 bg-white rounded-xl shadow-2xl border border-indigo-200 transform hover:shadow-indigo-300/50 transition duration-300">
                
                <h3 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Kursga kirish</h3>
                
                {# NARX KO'RSATISH #}
                <div class="mb-6">
                    <span class="text-4xl font-extrabold text-indigo-600">
                        {% if course.price > 0 and course.price is not None %}
                            {{ course.price }} UZS
                        {% else %}
                            BEPUL
                        {% endif %}
                    </span>
                    <p class="text-sm text-gray-500 mt-1">Barcha kontentga to'liq kirish huquqi.</p>
                </div>
                
                {# CTA TUGMASI #}
                <div>
                    {% if request.user.is_authenticated %}
                        
                        {% if is_enrolled %} 
                            {# Kursga yozilgan #}
                            <a href="{% url 'lesson_start' course.id %}" 
                               class="w-full inline-flex justify-center items-center px-6 py-4 text-xl font-bold text-white bg-green-500 rounded-xl hover:bg-green-600 transition shadow-lg shadow-green-300/50">
                                Darslarni boshlash <i class="fas fa-play ml-3"></i>
                            </a>
                            <p class="text-center text-sm text-green-600 mt-3 font-medium">Siz bu kurs talabasisiz.</p>
                        {% else %}
                            {# Kursga yozilmagan #}
                            <a href="{% url 'course_enroll' center.slug course.id %}" 
                               class="w-full inline-flex justify-center items-center px-6 py-4 text-xl font-bold text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 transition shadow-xl shadow-indigo-300/50">
                                Kursga yozilish <i class="fas fa-arrow-right ml-3"></i>
                            </a>
                            <p class="text-center text-sm text-gray-500 mt-3">Ro'yxatdan o'tish 1 daqiqa vaqt oladi.</p>
                        {% endif %}
                        
                    {% else %}
                        {# Tizimga kirmagan #}
                        <a href="{% url 'login' %}?next={{ request.path }}" 
                           class="w-full inline-flex justify-center items-center px-6 py-4 text-xl font-bold text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 transition shadow-xl shadow-indigo-300/50">
                            Kursga yozilish (Kirish) <i class="fas fa-sign-in-alt ml-3"></i>
                        </a>
                        <p class="text-center text-sm text-gray-500 mt-3">Avval tizimga kiring.</p>
                    {% endif %}
                </div>
            </div>

            
            {# üßë‚Äçüè´ O'QITUVCHI HAQIDA MA'LUMOT BLOKI #}
            {% if teacher_info %}
            <div class="p-6 bg-white rounded-xl shadow-xl border border-gray-100">
                <h3 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Kurs Ustozi</h3>
                <div class="flex items-center space-x-4">
                    <img class="w-16 h-16 rounded-full object-cover border-4 border-indigo-200 p-0.5" 
                                 src="{% if teacher_info.profile_picture %}{{ teacher_info.profile_picture.url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}" 
                                 alt="{{ teacher_info.full_name|default:teacher_info.username }}">
                    <div>
                        <p class="text-lg font-bold text-slate-900">{{ teacher_info.full_name|default:teacher_info.username }}</p>
                        <p class="text-sm text-indigo-600 font-medium">Mentor / Ekspert</p>
                    </div>
                </div>
                <p class="text-sm text-slate-600 mt-4 italic border-t pt-4">
                    {% if teacher_info.bio %}
                        {{ teacher_info.bio|truncatechars:200 }}
                    {% else %}
                        O'qituvchi o'zi haqida qisqacha ma'lumot kiritmagan.
                    {% endif %}
                </p>
            </div>
            {% endif %}
            
        </div>
        
    </div>
</div>
{% endblock %}