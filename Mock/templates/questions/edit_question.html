{% extends 'base.html' %}
{% load static %}

{% block title %}Savolni tahrirlash{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8">
    <div class="card-section">
        <h2 class="text-3xl md:text-4xl font-extrabold text-center text-gray-800 mb-6">Savolni tahrirlash</h2>
        <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">
            Savolning barcha ma'lumotlarini tahrirlang. To'g'ri formatni tanlab, unga mos javob variantlari yoki qisqa javobni kiriting.
        </p>

        <div>
            {% for message in messages %}
                <div class="p-4 mb-4 text-sm rounded-lg {% if message.tags == 'success' %}message-success{% elif message.tags == 'error' %}message-error{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>

        <form action="{% url 'edit_question' question.id %}" method="POST" enctype="multipart/form-data" id="question-form">
            {% csrf_token %}

            <div class="main-question-section card-section mb-8">
                <h3 class="card-title">
                    <i class="fas fa-question-circle mr-2 text-indigo-500"></i>Savol va javob variantlari
                </h3>
                
                <div class="mb-6">
                    <label for="{{ form.text.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.text.label }}</label>
                    {{ form.text }}
                    {% if form.text.errors %}<p class="text-red-500 text-sm mt-1">{{ form.text.errors }}</p>{% endif %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="{{ form.subtopic.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.subtopic.label }}</label>
                        {{ form.subtopic }}
                        {% if form.subtopic.errors %}<p class="text-red-500 text-sm mt-1">{{ form.subtopic.errors }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ form.answer_format.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.answer_format.label }}</label>
                        {{ form.answer_format }}
                        {% if form.answer_format.errors %}<p class="text-red-500 text-sm mt-1">{{ form.answer_format.errors }}</p>{% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="{{ form.passage.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.passage.label }}</label>
                        {{ form.passage }}
                        {% if form.passage.errors %}<p class="text-red-500 text-sm mt-1">{{ form.passage.errors }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ form.image.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.image.label }}</label>
                        {% if form.instance.image %}
                            <div class="mb-2">
                                <img src="{{ form.instance.image.url }}" alt="Savol rasmi" class="max-w-xs h-auto rounded-lg shadow-md">
                            </div>
                        {% endif %}
                        {{ form.image }}
                        {% if form.image.errors %}<p class="text-red-500 text-sm mt-1">{{ form.image.errors }}</p>{% endif %}
                    </div>
                </div>

                <div id="options-container" class="{% if question.answer_format == 'short_answer' %}hidden{% else %}block{% endif %}">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">Javob variantlari</h4>
                    <div id="options-list" class="space-y-4">
                    </div>
                    <button type="button" id="add-option" class="btn btn-primary mt-4">
                        <i class="fas fa-plus mr-2"></i>Yangi variant qo'shish
                    </button>
                </div>
                
                <div id="short-answer-field-container" class="{% if question.answer_format == 'short_answer' %}block{% else %}hidden{% endif %}">
                    <div class="mb-4">
                        <label for="id_correct_short_answer" class="block text-gray-700 font-medium mb-2">To'g'ri javob</label>
                        <input type="text" name="correct_short_answer" id="id_correct_short_answer" class="w-full border rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" value="{{ question.correct_short_answer|default:'' }}">
                    </div>
                </div>
            </div>

            <div class="solution-section card-section mb-8">
                <h3 class="card-title">
                    <i class="fas fa-book-open mr-2 text-indigo-500"></i>Yechim
                </h3>
                <div class="mb-6">
                    <label for="{{ form.hint.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.hint.label }}</label>
                    {{ form.hint }}
                    {% if form.hint.errors %}<p class="text-red-500 text-sm mt-1">{{ form.hint.errors }}</p>{% endif %}
                </div>
                <div class="mb-6">
                    <label for="{{ form.detailed_solution.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.detailed_solution.label }}</label>
                    {{ form.detailed_solution }}
                    {% if form.detailed_solution.errors %}<p class="text-red-500 text-sm mt-1">{{ form.detailed_solution.errors }}</p>{% endif %}
                </div>
            </div>
            
            <div class="meta-section card-section mb-8">
                <h3 class="card-title">
                    <i class="fas fa-info-circle mr-2 text-indigo-500"></i>Qo'shimcha ma'lumotlar
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="{{ form.difficulty_level.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.difficulty_level.label }}</label>
                        {{ form.difficulty_level }}
                        {% if form.difficulty_level.errors %}<p class="text-red-500 text-sm mt-1">{{ form.difficulty_level.errors }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ form.difficulty.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.difficulty.label }}</label>
                        {{ form.difficulty }}
                        {% if form.difficulty.errors %}<p class="text-red-500 text-sm mt-1">{{ form.difficulty.errors }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ form.status.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.status.label }}</label>
                        {{ form.status }}
                        {% if form.status.errors %}<p class="text-red-500 text-sm mt-1">{{ form.status.errors }}</p>{% endif %}
                    </div>
                </div>

                <div class="mb-6">
                    <label for="{{ form.flashcards.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.flashcards.label }}</label>
                    {{ form.flashcards }}
                    {% if form.flashcards.errors %}<p class="text-red-500 text-sm mt-1">{{ form.flashcards.errors }}</p>{% endif %}
                    <div id="selected-flashcards" class="mt-4 hidden">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Tanlangan Flashcardlar</h4>
                        <div class="bg-gray-100 p-4 rounded-md flex flex-wrap gap-2">
                            <div id="selected-flashcards-list" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="{{ form.tags.id_for_label }}" class="block text-gray-700 font-medium mb-2">{{ form.tags.label }}</label>
                    {{ form.tags }}
                    {% if form.tags.errors %}<p class="text-red-500 text-sm mt-1">{{ form.tags.errors }}</p>{% endif %}
                    <div id="selected-tags" class="mt-4 hidden">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Tanlangan Teglar</h4>
                        <div class="bg-gray-100 p-4 rounded-md flex flex-wrap gap-2">
                            <div id="selected-tags-list" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-end mt-8 space-y-4 sm:space-y-0 sm:space-x-4">
                <a href="{% url 'my_questions' %}" class="btn btn-secondary">
                    <i class="fas fa-times mr-2"></i>Bekor qilish
                </a>
                <button type="submit" name="save" class="btn btn-primary">
                    <i class="fas fa-save mr-2"></i>Saqlash
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_body %}
    <script>
        const initialOptions = [
            {% for option in question.options.all %}
                { text: `{{ option.text|escapejs }}`, is_correct: {{ option.is_correct|yesno:"true,false" }} },
            {% endfor %}
        ];
    </script>
    <script>
        $(document).ready(function() {
            // CKEditor maydonlarini avtomatik ravishda initsializatsiya qilish
            // Django-CKEditor buni o'zi amalga oshiradi, shuning uchun maxsus funksiyaga hojat yo'q
            
            const answerFormatSelect = $('#id_answer_format');
            const optionsContainer = $('#options-container');
            const shortAnswerFieldContainer = $('#short-answer-field-container');
            const addOptionButton = $('#add-option');
            const optionsList = $('#options-list');
            let optionCount = 0;

            function updateForm() {
                const selectedFormat = answerFormatSelect.val();
                if (selectedFormat === 'single' || selectedFormat === 'multiple') {
                    optionsContainer.removeClass('hidden');
                    shortAnswerFieldContainer.addClass('hidden');
                    // Agar o'zgartirilgan bo'lsa, variantlarni tozalab, qayta yuklash
                    optionsList.empty();
                    optionCount = 0;
                    if (initialOptions.length > 0) {
                        initialOptions.forEach(option => addOption(option.text, option.is_correct));
                    } else {
                        addOption();
                        addOption();
                    }
                } else if (selectedFormat === 'short_answer') {
                    optionsContainer.addClass('hidden');
                    shortAnswerFieldContainer.removeClass('hidden');
                }
            }

            function addOption(text = '', is_correct = false) {
                optionCount++;
                const optionDiv = $(`
                    <div class="option-item bg-gray-100 p-4 rounded-lg border border-gray-200 mb-4">
                        <div class="flex items-center mb-2">
                            <input type="${answerFormatSelect.val() === 'single' ? 'radio' : 'checkbox'}" name="is_correct" value="${optionCount}" class="form-checkbox h-5 w-5 text-green-600 mr-2" ${is_correct ? 'checked' : ''}>
                            <label class="text-gray-700 font-medium">To'g'ri javob ${optionCount}</label>
                            <button type="button" class="remove-option ml-auto text-red-500 hover:text-red-700 transition duration-200">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <label class="block text-gray-700 font-medium mb-2">Javob varianti ${optionCount}</label>
                        <textarea name="option_text" id="option_text_${optionCount}" class="editor w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" rows="4">${text}</textarea>
                    </div>
                `);
                optionsList.append(optionDiv);
                
                // CKEditor'ni yangi textarea uchun ishga tushirish
                CKEDITOR.replace(`option_text_${optionCount}`);
            }

            function removeOption(event) {
                const optionItems = $('.option-item').length;
                if (optionItems > 2) {
                    const optionDiv = $(event.target).closest('.option-item');
                    const editorId = optionDiv.find('textarea').attr('id');
                    if (CKEDITOR.instances[editorId]) {
                        CKEDITOR.instances[editorId].destroy();
                    }
                    optionDiv.remove();
                } else {
                    alert('Kamida 2 ta javob varianti boâ€˜lishi kerak!');
                }
            }
            
            // Sahifa yuklanganda mavjud variantlarni yuklash
            if (initialOptions.length > 0 && (answerFormatSelect.val() === 'single' || answerFormatSelect.val() === 'multiple')) {
                initialOptions.forEach(option => addOption(option.text, option.is_correct));
            } else if (initialOptions.length === 0 && (answerFormatSelect.val() === 'single' || answerFormatSelect.val() === 'multiple')) {
                addOption();
                addOption();
            }

            // Voqea tinglovchilari
            answerFormatSelect.on('change', function() {
                const selectedFormat = $(this).val();
                if (selectedFormat === 'single' || selectedFormat === 'multiple') {
                    optionsContainer.removeClass('hidden');
                    shortAnswerFieldContainer.addClass('hidden');
                    // Format o'zgarganda variantlarni tozalab, yangilash
                    optionsList.empty();
                    optionCount = 0;
                    if (initialOptions.length > 0) {
                        initialOptions.forEach(option => addOption(option.text, option.is_correct));
                    } else {
                        addOption();
                        addOption();
                    }
                } else {
                    optionsContainer.addClass('hidden');
                    shortAnswerFieldContainer.removeClass('hidden');
                    // Variantlarni o'chirish
                    for (const instance in CKEDITOR.instances) {
                        CKEDITOR.instances[instance].destroy();
                    }
                }
            });
            addOptionButton.on('click', () => addOption());
            optionsList.on('click', '.remove-option', removeOption);

            $('#question-form').on('submit', function(e) {
                // Forma yuborilishidan oldin barcha CKEditor ma'lumotlarini saqlash
                for (const instance in CKEDITOR.instances) {
                    CKEDITOR.instances[instance].updateElement();
                }
                const selectedFormat = answerFormatSelect.val();

                if (selectedFormat === 'single' || selectedFormat === 'multiple') {
                    const checked = $('input[name="is_correct"]:checked').length;
                    const optionTexts = $('textarea[name="option_text"]').map(function() { return CKEDITOR.instances[this.id].getData().trim(); }).get();
                    const validOptions = optionTexts.filter(text => text.length > 0).length;

                    if (validOptions < 2) {
                        alert('Kamida 2 ta javob varianti kiritilishi shart!');
                        e.preventDefault();
                        return;
                    }

                    if (selectedFormat === 'single' && checked !== 1) {
                        alert('Yagona javob formatida faqat bitta to\'g\'ri javob tanlanishi kerak!');
                        e.preventDefault();
                        return;
                    }
                    if (selectedFormat === 'multiple' && checked === 0) {
                        alert('Bir nechta javob formatida kamida bitta to\'g\'ri javob tanlanishi kerak!');
                        e.preventDefault();
                        return;
                    }
                }
            });

            // Select2 init
            $('#id_subtopic, #id_passage, #id_difficulty_level, #id_status').select2({ theme: "classic" });
            $('#id_tags').select2({ placeholder: "Teg izlash...", theme: "classic", tags: false, tokenSeparators: [',', ' '] });
            $('#id_flashcards').select2({
                placeholder: "Flashcard izlash...",
                theme: "classic",
                tags: false,
                ajax: {
                    url: '{% url "search_flashcards_api" %}',
                    dataType: 'json',
                    delay: 250,
                    data: params => ({ q: params.term }),
                    processResults: data => ({ results: data.results }),
                    cache: true
                },
                templateResult: data => $('<span>').html(data.text),
                templateSelection: data => $('<span>').text($('<div>').html(data.text).text())
            });

            // Tanlangan itemlarni ko'rsatish
            const updateSelectedItems = (selector, listSelector, itemType) => {
                const selectedItemsDiv = $(listSelector);
                selectedItemsDiv.empty();
                const selectedData = $(selector).select2('data');
                const containerId = (itemType === 'flashcard') ? '#selected-flashcards' : '#selected-tags';
                $(containerId).toggleClass('hidden', selectedData.length === 0);
                
                selectedData.forEach(item => {
                    const text = $('<div>').html(item.text).text().replace(' (yangi)', '');
                    let itemHtml;
                    if (itemType === 'flashcard') {
                        const parts = text.split(' - ');
                        const english = parts[0];
                        const uzbek = parts.length > 1 ? parts.slice(1).join(' - ') : '';
                        itemHtml = `
                            <div class="flashcard-item bg-white border border-gray-200 rounded-lg p-3 shadow-sm flex items-center justify-between min-w-[200px] gap-2">
                                <div>
                                    <span class="block text-sm font-bold text-gray-800">${english}</span>
                                    <span class="block text-xs text-gray-600">${uzbek}</span>
                                </div>
                                <button type="button" class="remove-item text-red-500 hover:text-red-700 font-bold self-start transition duration-200" data-id="${item.id}" data-item-type="${itemType}">&times;</button>
                            </div>
                        `;
                    } else if (itemType === 'tag') {
                        itemHtml = `
                            <div class="flex items-center selected-item-tag py-1 px-3">
                                <span class="text-sm font-medium text-blue-800">${text}</span>
                                <button type="button" class="remove-item text-blue-500 hover:text-blue-700 ml-2 font-bold transition duration-200" data-id="${item.id}" data-item-type="${itemType}">&times;</button>
                            </div>
                        `;
                    }
                    selectedItemsDiv.append(itemHtml);
                });
            };

            $('#id_flashcards').on('change', () => updateSelectedItems('#id_flashcards', '#selected-flashcards-list', 'flashcard'));
            $('#id_tags').on('change', () => updateSelectedItems('#id_tags', '#selected-tags-list', 'tag'));
            
            $('.container').on('click', '.remove-item', function() {
                const idToRemove = $(this).data('id').toString();
                const itemType = $(this).data('item-type');
                const selector = (itemType === 'flashcard') ? '#id_flashcards' : '#id_tags';
                const selectedIds = $(selector).val();
                const newIds = Array.isArray(selectedIds) ? selectedIds.filter(val => val.toString() !== idToRemove) : null;
                $(selector).val(newIds).trigger('change');
            });
            
            updateSelectedItems('#id_flashcards', '#selected-flashcards-list', 'flashcard');
            updateSelectedItems('#id_tags', '#selected-tags-list', 'tag');
        });
    </script>
{% endblock %}