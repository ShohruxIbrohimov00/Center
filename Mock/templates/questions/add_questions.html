{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Yangi savol qo'shish" %}{% endblock %}

{% block head %}
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.ckeditor.com/4.25.1-lts/standard/ckeditor.js"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8 max-w-5xl">
    <div class="bg-white shadow-lg rounded-lg p-6 md:p-8">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">{% trans "Yangi savol qo'shish" %}</h2>
        <p class="text-gray-600 mb-6">{% trans "Savol matni, javoblar va IRT parametrlarni to'g'ri kiriting. SAT Digital formatiga mos savollar yarating." %}</p>

        {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
            <div class="p-4 mb-4 text-sm rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}" role="alert">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form action="{% url 'add_question' %}" method="POST" enctype="multipart/form-data" id="question-form" class="space-y-6">
            {% csrf_token %}

            <!-- Savol ma'lumotlari -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-question-circle mr-2 text-indigo-600"></i>{% trans "Savol ma'lumotlari" %}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="id_text" class="block text-gray-700 font-medium mb-1">{% trans "Savol matni" %}</label>
                        {{ form.text }}
                        {% if form.text.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.text.errors }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="id_subtopic" class="block text-gray-700 font-medium mb-1">{% trans "Ichki mavzu" %}</label>
                        {{ form.subtopic }}
                        {% if form.subtopic.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.subtopic.errors }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="id_answer_format" class="block text-gray-700 font-medium mb-1">{% trans "Javob formati" %}</label>
                        {{ form.answer_format }}
                        {% if form.answer_format.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.answer_format.errors }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="id_passage" class="block text-gray-700 font-medium mb-1">{% trans "Matn (Passage)" %}</label>
                        {{ form.passage }}
                        {% if form.passage.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.passage.errors }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="id_image" class="block text-gray-700 font-medium mb-1">{% trans "Rasm (agar kerak bo'lsa)" %}</label>
                        {{ form.image }}
                        {% if form.image.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.image.errors }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Javob variantlari -->
            <div id="options-container" class="bg-gray-50 p-4 rounded-lg hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">{% trans "Javob variantlari" %}</h3>
                <div id="options-list" class="space-y-4">
                    {{ answer_option_formset.management_form }}
                    {% for option_form in answer_option_formset %}
                    <div class="option-item bg-gray-100 p-3 rounded-md border border-gray-200 mb-3">
                        <div class="flex items-center mb-2">
                            {{ option_form.is_correct }}
                            <label class="text-gray-700 font-medium ml-2">{% trans "To'g'ri javob" %}</label>
                            <button type="button" class="remove-option ml-auto text-red-500 hover:text-red-700">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            {{ option_form.DELETE }}
                            {{ option_form.id }}
                        </div>
                        {{ option_form.text }}
                        {% if option_form.text.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ option_form.text.errors }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-option" class="mt-4 inline-flex items-center px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    <i class="fas fa-plus mr-2"></i>{% trans "Javob varianti qo'shish" %}
                </button>
            </div>

            <!-- Qisqa javob -->
            <div id="short-answer-field-container" class="bg-gray-50 p-4 rounded-lg hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">{% trans "Qisqa javob" %}</h3>
                <label for="id_correct_short_answer" class="block text-gray-700 font-medium mb-1">{% trans "To'g'ri javob" %}</label>
                {{ form.correct_short_answer }}
                {% if form.correct_short_answer.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.correct_short_answer.errors }}</p>
                {% endif %}
            </div>

            <!-- Yechim -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-book-open mr-2 text-indigo-600"></i>{% trans "Yechim" %}
                </h3>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="id_hint" class="block text-gray-700 font-medium mb-1">{% trans "Maslahat" %}</label>
                        {{ form.hint }}
                        {% if form.hint.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.hint.errors }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="id_detailed_solution" class="block text-gray-700 font-medium mb-1">{% trans "Batafsil yechim" %}</label>
                        {{ form.detailed_solution }}
                        {% if form.detailed_solution.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.detailed_solution.errors }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- IRT parametrlari -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-indigo-600"></i>{% trans "IRT parametrlari" %}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="id_difficulty" class="block text-gray-700 font-medium mb-1">{% trans "Qiyinlik (Difficulty)" %}</label>
                        {{ form.difficulty }}
                        <p class="text-gray-500 text-sm mt-1">Oson: -3.0 to -1.0, Oâ€˜rta: -1.0 to 1.0, Qiyin: 1.0 to 3.0</p>
                        {% if form.difficulty.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.difficulty.errors }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="id_discrimination" class="block text-gray-700 font-medium mb-1">{% trans "Diskriminatsiya (Discrimination)" %}</label>
                        {{ form.discrimination }}
                        {% if form.discrimination.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.discrimination.errors }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="id_guessing" class="block text-gray-700 font-medium mb-1">{% trans "Taxmin qilish (Guessing)" %}</label>
                        {{ form.guessing }}
                        {% if form.guessing.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.guessing.errors }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Qo'shimcha ma'lumotlar -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-indigo-600"></i>{% trans "Qo'shimcha ma'lumotlar" %}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="id_difficulty_level" class="block text-gray-700 font-medium mb-1">{% trans "Qiyinlik darajasi" %}</label>
                        {{ form.difficulty_level }}
                        {% if form.difficulty_level.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.difficulty_level.errors }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="id_status" class="block text-gray-700 font-medium mb-1">{% trans "Status" %}</label>
                        {{ form.status }}
                        {% if form.status.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.status.errors }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="id_is_solution_free" class="block text-gray-700 font-medium mb-1">{% trans "Yechim bepulmi?" %}</label>
                        {{ form.is_solution_free }}
                        {% if form.is_solution_free.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.is_solution_free.errors }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-4">
                    <label for="id_tags" class="block text-gray-700 font-medium mb-1">{% trans "Teglar" %}</label>
                    {{ form.tags }}
                    {% if form.tags.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.tags.errors }}</p>
                    {% endif %}
                </div>
                <div class="mt-4">
                    <label for="id_flashcards" class="block text-gray-700 font-medium mb-1">{% trans "Flashcardlar" %}</label>
                    {{ form.flashcards }}
                    {% if form.flashcards.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.flashcards.errors }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Tugmalar -->
            <div class="flex flex-col sm:flex-row justify-end mt-6 space-y-3 sm:space-y-0 sm:space-x-3">
                <a href="{% url 'my_questions' %}" class="inline-flex items-center px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">
                    <i class="fas fa-times mr-2"></i>{% trans "Bekor qilish" %}
                </a>
                <button type="submit" name="save" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    <i class="fas fa-save mr-2"></i>{% trans "Saqlash" %}
                </button>
                <button type="submit" name="save_and_add_another" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    <i class="fas fa-plus mr-2"></i>{% trans "Saqlab, yana qo'shish" %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_body %}
<script>
    CKEDITOR.config.mathJaxLib = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    const editorConfig = {
        toolbar: [
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Subscript', 'Superscript'] },
            { name: 'paragraph', items: ['NumberedList', 'BulletedList'] },
            { name: 'insert', items: ['Image2', 'Table', 'SpecialChar'] },
            { name: 'styles', items: ['Format'] },
            { name: 'tools', items: ['Maximize'] },
            { name: 'math', items: ['Mathjax'] }
        ],
        extraPlugins: 'image2,mathjax,autogrow',
        removePlugins: 'image',
        height: 150,
        autoGrow_onStartup: true
    };

    $(document).ready(function() {
        const answerFormatSelect = $('#id_answer_format');
        const optionsContainer = $('#options-container');
        const shortAnswerFieldContainer = $('#short-answer-field-container');
        const optionsList = $('#options-list');
        const difficultyLevelSelect = $('#id_difficulty_level');
        const difficultyInput = $('#id_difficulty');
        let optionCount = parseInt($('#options-TOTAL_FORMS').val(), 10);

        // Form holatini yangilash
        function updateForm() {
            const selectedFormat = answerFormatSelect.val();
            optionsContainer.addClass('hidden');
            shortAnswerFieldContainer.addClass('hidden');
            if (selectedFormat === 'single' || selectedFormat === 'multiple') {
                optionsContainer.removeClass('hidden');
                updateOptionInputs(selectedFormat);
            } else if (selectedFormat === 'short_answer') {
                shortAnswerFieldContainer.removeClass('hidden');
                optionsList.find('.option-item').each(function() {
                    const editorId = $(this).find('textarea').attr('id');
                    if (editorId && CKEDITOR.instances[editorId]) {
                        CKEDITOR.instances[editorId].destroy(true);
                    }
                });
            }
        }

        // Javob variantlarini yangilash
        function updateOptionInputs(format) {
            const inputType = format === 'single' ? 'radio' : 'checkbox';
            $('.option-item').each(function() {
                const $input = $(this).find('input[name$="is_correct"]');
                const isChecked = $input.is(':checked');
                const name = $input.attr('name');
                const newInput = $(`
                    <input type="${inputType}" name="${name}" value="true" class="form-checkbox h-5 w-5 text-indigo-600 mr-2" ${isChecked ? 'checked' : ''}>
                `);
                $input.replaceWith(newInput);
            });
        }

        // Difficulty_level ga qarab difficulty ni yangilash
        function updateDifficultyInput() {
            const selectedLevel = difficultyLevelSelect.val();
            if (selectedLevel === 'easy') {
                difficultyInput.val('-1.0');
            } else if (selectedLevel === 'medium') {
                difficultyInput.val('0.0');
            } else if (selectedLevel === 'hard') {
                difficultyInput.val('1.5');
            }
        }

        // Yangi javob varianti qo'shish
        function addOption() {
            if (optionCount >= 5) {
                alert('{% trans "Maksimal 5 ta javob varianti qo'shish mumkin!"|escapejs %}');
                return;
            }
            const inputType = answerFormatSelect.val() === 'single' ? 'radio' : 'checkbox';
            const formIndex = optionCount;
            const uniqueId = `option-text-${formIndex}-${Date.now()}`;
            const optionDiv = $(`
                <div class="option-item bg-gray-100 p-3 rounded-md border border-gray-200 mb-3">
                    <div class="flex items-center mb-2">
                        <input type="${inputType}" name="options-${formIndex}-is_correct" id="id_options-${formIndex}-is_correct" value="true" class="form-checkbox h-5 w-5 text-indigo-600 mr-2">
                        <label class="text-gray-700 font-medium">{% trans "To'g'ri javob" %}</label>
                        <button type="button" class="remove-option ml-auto text-red-500 hover:text-red-700">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <input type="hidden" name="options-${formIndex}-DELETE" id="id_options-${formIndex}-DELETE" value="false">
                        <input type="hidden" name="options-${formIndex}-id" id="id_options-${formIndex}-id" value="">
                    </div>
                    <textarea name="options-${formIndex}-text" id="${uniqueId}" class="w-full border rounded-md p-2 focus:ring-2 focus:ring-indigo-600"></textarea>
                </div>
            `);
            optionsList.append(optionDiv);
            if (!CKEDITOR.instances[uniqueId]) {
                CKEDITOR.replace(uniqueId, editorConfig);
            }
            optionCount++;
            $('#options-TOTAL_FORMS').val(optionCount);
        }

        // Javob varianti o'chirish
        function removeOption(event) {
            const $optionItem = $(event.target).closest('.option-item');
            if ($('.option-item:not(.hidden)').length > 2) {
                const editorId = $optionItem.find('textarea').attr('id');
                if (editorId && CKEDITOR.instances[editorId]) {
                    CKEDITOR.instances[editorId].destroy(true);
                }
                $optionItem.find('input[name$="DELETE"]').val('true');
                $optionItem.addClass('hidden');
                optionCount = $('.option-item:not(.hidden)').length;
                $('#options-TOTAL_FORMS').val(optionCount);
            } else {
                alert('{% trans "Kamida 2 ta javob varianti bo'lishi kerak!"|escapejs %}');
            }
        }

        // CKEditor sozlamalari
        if (!CKEDITOR.instances['id_text']) {
            CKEDITOR.replace('id_text', Object.assign({}, editorConfig, { height: 200 }));
        }
        if (!CKEDITOR.instances['id_hint']) {
            CKEDITOR.replace('id_hint', Object.assign({}, editorConfig, { height: 150 }));
        }
        if (!CKEDITOR.instances['id_detailed_solution']) {
            CKEDITOR.replace('id_detailed_solution', Object.assign({}, editorConfig, { height: 200 }));
        }
        $('.option-item textarea').each(function() {
            const textareaId = $(this).attr('id');
            if (textareaId && !CKEDITOR.instances[textareaId]) {
                CKEDITOR.replace(textareaId, editorConfig);
            }
        });

        // Add event listeners
        $('#add-option').on('click', addOption);
        $(document).on('click', '.remove-option', removeOption);
        answerFormatSelect.on('change', updateForm).trigger('change');
        difficultyLevelSelect.on('change', updateDifficultyInput).trigger('change');

        // Formni tekshirish
        $('#question-form').on('submit', function(e) {
            // CKEditor instansiyalarini yangilash
            for (const instance in CKEDITOR.instances) {
                CKEDITOR.instances[instance].updateElement();
            }
            // Formset ma'lumotlarini tekshirish
            console.log("TOTAL_FORMS:", $('#options-TOTAL_FORMS').val());
            $('.option-item').each(function(index) {
                const text = $(this).find('textarea').val();
                const isCorrect = $(this).find('input[name$="is_correct"]').is(':checked');
                const isDeleted = $(this).find('input[name$="DELETE"]').val();
                console.log(`Option ${index}:`, {
                    text: text,
                    is_correct: isCorrect,
                    DELETE: isDeleted
                });
            });
        });

        // Select2 sozlamalari
        $('#id_subtopic').select2({ placeholder: "{% trans 'Mavzu izlash...' %}", theme: "classic" });
        $('#id_passage').select2({ placeholder: "{% trans 'Matn izlash...' %}", theme: "classic" });
        $('#id_difficulty_level').select2({ placeholder: "{% trans 'Qiyinlik darajasi...' %}", theme: "classic" });
        $('#id_status').select2({ placeholder: "{% trans 'Status...' %}", theme: "classic" });
        $('#id_tags').select2({
            placeholder: "{% trans 'Teg izlash...' %}",
            theme: "classic",
            tags: true,
            tokenSeparators: [',', ' ']
        });
        $('#id_flashcards').select2({
            placeholder: "{% trans 'Flashcard izlash...' %}",
            theme: "classic",
            ajax: {
                url: '{% url "search_flashcards_api" %}',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return { q: params.term };
                },
                processResults: function(data) {
                    return { results: data.results };
                }
            }
        });
    });
</script>
{% endblock %}